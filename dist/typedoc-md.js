"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const types = {
    Function: 64,
    Interface: 256,
    Property: 1024
};
class DocGenerator {
    constructor(cfg) {
        this.cwd = cfg.cwd;
        this.urlBase = cfg.urlBase;
        this.linkTable = {};
    }
    getPath(absPath) {
        return path.relative(this.cwd, absPath)
            .replace(/\\/g, '/')
            .replace(/\.[^\.]*$/, '.md');
    }
    getSignatureCode(meta) {
        if (!meta) {
            return [];
        }
        const resultType = this.type(meta.type, false);
        return [
            '```typescript',
            `(${this.args(meta.parameters)}) => ${resultType}`,
            '```'
        ];
    }
    signature(meta) {
        const name = meta.name;
        const typeArgs = this.typeParam(meta.typeParameter);
        let lines = [
            `Function [${name + typeArgs}]`,
            '===',
            '',
            'Signature',
            '---'
        ];
        lines = lines.concat(this.getSignatureCode(meta));
        lines.push('');
        if (meta.comment) {
            lines = lines.concat([
                'Description',
                '---',
                meta.comment.shortText,
                ''
            ]);
        }
        lines = lines.concat(this.params(meta.parameters));
        return lines.join('\n');
    }
    params(meta) {
        if (!meta || meta.length === 0) {
            return [];
        }
        let lines = [
            'Parameters',
            '---'
        ];
        lines = lines.concat(meta.map(param => {
            const desc = param.comment
                ? ` - ${param.comment.text}`
                : '';
            return `- **${param.name}**: ${this.type(param.type)}` + desc;
        }));
        return lines;
    }
    args(meta) {
        if (!meta || meta.length === 0) {
            return '';
        }
        return meta
            .map(arg => `${arg.name}: ${this.type(arg.type, false)}`)
            .join(', ');
    }
    interface(meta) {
        let lines = [];
        if (meta.id) {
            lines.push(`<a name="id-${meta.id}"></a>`);
        }
        lines.push(`Interface [${meta.name}]`, '===', '');
        if (meta.signatures) {
            lines.push('Signature', '---', ...this.getSignatureCode(meta.signatures[0]));
        }
        if (meta.children && meta.children.length > 0) {
            const props = meta.children.filter(prop => prop.kind = types.Property);
            lines.push('Propeties:', '---');
            lines = lines.concat(props.map(prop => {
                return `- ${prop.name}: ${this.type(prop.type)}`;
            }));
            lines.push('');
        }
        return lines.join('\n');
    }
    ref(refData, text) {
        const path = this.getPath(refData.place);
        const hash = 'id-' + refData.meta.id;
        const url = [this.urlBase, path, '#', hash].join('');
        return `[${text}](${url})`;
    }
    type(meta, allowLinks = true) {
        let res = meta.name;
        if (meta.typeArguments && meta.typeArguments.length > 0) {
            // todo: add typeArgs
        }
        if (allowLinks && meta.type === 'reference' && meta.id) {
            const ref = this.linkTable[meta.id];
            res = this.ref(ref, res);
        }
        return res || '<unsupported-type>';
    }
    typeParam(meta) {
        if (!meta || meta.length === 0) {
            return '';
        }
        const typeList = meta.map(m => m.name).join(', ');
        return `\\<${typeList}\\>`;
    }
    any(meta) {
        switch (meta.kind) {
            case types.Function:
                return this.signature(meta.signatures[0]);
            case types.Interface:
                return this.interface(meta);
        }
    }
    genDocs(meta) {
        meta.children.forEach(module => {
            module.children
                .forEach(item => {
                if (item.id) {
                    this.linkTable[item.id] = {
                        meta: item,
                        place: module.originalName
                    };
                }
            });
        });
        return meta.children.map(module => ({
            path: this.getPath(module.originalName),
            content: module.children
                .map(item => this.any(item))
                .join('\n\n')
        }));
    }
}
exports.DocGenerator = DocGenerator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHlwZWRvYy1tZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy90eXBlZG9jLW1kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNkJBQTZCO0FBRTdCLE1BQU0sS0FBSyxHQUFHO0lBQ1YsUUFBUSxFQUFFLEVBQUU7SUFDWixTQUFTLEVBQUUsR0FBRztJQUNkLFFBQVEsRUFBRSxJQUFJO0NBQ2pCLENBQUE7QUFpQkQ7SUFLSSxZQUFhLEdBQWM7UUFDdkIsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDO1FBQ25CLElBQUksQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQztRQUMzQixJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztJQUN4QixDQUFDO0lBRUQsT0FBTyxDQUFDLE9BQWU7UUFDbkIsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUM7YUFDbEMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUM7YUFDbkIsT0FBTyxDQUFDLFdBQVcsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNyQyxDQUFDO0lBRUQsZ0JBQWdCLENBQUMsSUFBSTtRQUNqQixFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDUixNQUFNLENBQUMsRUFBRSxDQUFDO1FBQ2QsQ0FBQztRQUNELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztRQUMvQyxNQUFNLENBQUM7WUFDSCxlQUFlO1lBQ2YsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxVQUFVLEVBQUU7WUFDbEQsS0FBSztTQUNSLENBQUE7SUFDTCxDQUFDO0lBRUQsU0FBUyxDQUFDLElBQUk7UUFDVixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMs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LFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzlDLEtBQUssS0FBSyxDQUFDLFNBQVM7Z0JBQ2hCLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BDLENBQUM7SUFDTCxDQUFDO0lBRUQsT0FBTyxDQUFDLElBQUk7UUFDUixJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxNQUFNO1lBQ3hCLE1BQU0sQ0FBQyxRQUFRO2lCQUNWLE9BQU8sQ0FBQyxJQUFJO2dCQUNULEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO29CQUNWLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHO3dCQUN0QixJQUFJLEVBQUUsSUFBSTt3QkFDVixLQUFLLEVBQUUsTUFBTSxDQUFDLFlBQVk7cUJBQzdCLENBQUM7Z0JBQ04sQ0FBQztZQUNMLENBQUMsQ0FBQyxDQUFBO1FBQ1YsQ0FBQyxDQUFDLENBQUM7UUFDSCxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsTUFBTSxJQUFJLENBQUM7WUFDaEMsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQztZQUN2QyxPQUFPLEVBQUUsTUFBTSxDQUFDLFFBQVE7aUJBQ25CLEdBQUcsQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDM0IsSUFBSSxDQUFDLE1BQU0sQ0FBQztTQUNwQixDQUFDLENBQUMsQ0FBQztJQUNSLENBQUM7Q0FDSjtBQXJLRCxvQ0FxS0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xyXG5cclxuY29uc3QgdHlwZXMgPSB7XHJcbiAgICBGdW5jdGlvbjogNjQsXHJcbiAgICBJbnRlcmZhY2U6IDI1NixcclxuICAgIFByb3BlcnR5OiAxMDI0XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgUmVmUmVjb3JkIHtcclxuICAgIG1ldGE6IGFueTtcclxuICAgIHBsYWNlOiBzdHJpbmc7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRG9jR2VuQ2ZnIHtcclxuICAgIGN3ZDogc3RyaW5nO1xyXG4gICAgdXJsQmFzZTogc3RyaW5nO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIERvY0VudGl0eSB7XHJcbiAgICBjb250ZW50OiBzdHJpbmc7XHJcbiAgICBwYXRoOiBzdHJpbmc7XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBEb2NHZW5lcmF0b3Ige1xyXG4gICAgbGlua1RhYmxlOiB7W2tleTogc3RyaW5nXTogUmVmUmVjb3JkfTtcclxuICAgIGN3ZDogc3RyaW5nO1xyXG4gICAgdXJsQmFzZTogc3RyaW5nO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yIChjZmc6IERvY0dlbkNmZykge1xyXG4gICAgICAgIHRoaXMuY3dkID0gY2ZnLmN3ZDtcclxuICAgICAgICB0aGlzLnVybEJhc2UgPSBjZmcudXJsQmFzZTtcclxuICAgICAgICB0aGlzLmxpbmtUYWJsZSA9IHt9O1xyXG4gICAgfVxyXG5cclxuICAgIGdldFBhdGgoYWJzUGF0aDogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgICAgICByZXR1cm4gcGF0aC5yZWxhdGl2ZSh0aGlzLmN3ZCwgYWJzUGF0aClcclxuICAgICAgICAgICAgLnJlcGxhY2UoL1xcXFwvZywgJy8nKVxyXG4gICAgICAgICAgICAucmVwbGFjZSgvXFwuW15cXC5dKiQvLCAnLm1kJyk7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0U2lnbmF0dXJlQ29kZShtZXRhKSB7XHJcbiAgICAgICAgaWYgKCFtZXRhKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBbXTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgcmVzdWx0VHlwZSA9IHRoaXMudHlwZShtZXRhLnR5cGUsIGZhbHNlKTtcclxuICAgICAgICByZXR1cm4gWyAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAnYGBgdHlwZXNjcmlwdCcsXHJcbiAgICAgICAgICAgIGAoJHt0aGlzLmFyZ3MobWV0YS5wYXJhbWV0ZXJzKX0pID0+ICR7cmVzdWx0VHlwZX1gLFxyXG4gICAgICAgICAgICAnYGBgJyAgICAgICBcclxuICAgICAgICBdXHJcbiAgICB9XHJcblxyXG4gICAgc2lnbmF0dXJlKG1ldGEpIHtcclxuICAgICAgICBjb25zdCBuYW1lID0gbWV0YS5uYW1lO1xyXG4gICAgICAgIGNvbnN0IHR5cGVBcmdzID0gdGhpcy50eXBlUGFyYW0obWV0YS50eXBlUGFyYW1ldGVyKTtcclxuICAgICAgICBsZXQgbGluZXMgPSBbXHJcbiAgICAgICAgICAgIGBGdW5jdGlvbiBbJHtuYW1lICsgdHlwZUFyZ3N9XWAsXHJcbiAgICAgICAgICAgICc9PT0nLFxyXG4gICAgICAgICAgICAnJyxcclxuICAgICAgICAgICAgJ1NpZ25hdHVyZScsXHJcbiAgICAgICAgICAgICctLS0nXHJcbiAgICAgICAgXTsgICAgXHJcbiAgICAgICAgbGluZXMgPSBsaW5lcy5jb25jYXQodGhpcy5nZXRTaWduYXR1cmVDb2RlKG1ldGEpKTtcclxuICAgICAgICBsaW5lcy5wdXNoKCcnKTtcclxuICAgICAgICBpZiAobWV0YS5jb21tZW50KSB7XHJcbiAgICAgICAgICAgIGxpbmVzID0gbGluZXMuY29uY2F0KFtcclxuICAgICAgICAgICAgICAgICdEZXNjcmlwdGlvbicsXHJcbiAgICAgICAgICAgICAgICAnLS0tJyxcclxuICAgICAgICAgICAgICAgIG1ldGEuY29tbWVudC5zaG9ydFRleHQsXHJcbiAgICAgICAgICAgICAgICAnJyAgICAgXHJcbiAgICAgICAgICAgIF0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsaW5lcyA9IGxpbmVzLmNvbmNhdCh0aGlzLnBhcmFtcyhtZXRhLnBhcmFtZXRlcnMpKTtcclxuICAgICAgICByZXR1cm4gbGluZXMuam9pbignXFxuJyk7XHJcbiAgICB9XHJcblxyXG4gICAgcGFyYW1zKG1ldGEpIHtcclxuICAgICAgICBpZiAoIW1ldGEgfHwgbWV0YS5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuIFtdO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgbGluZXMgPSBbXHJcbiAgICAgICAgICAgICdQYXJhbWV0ZXJzJyxcclxuICAgICAgICAgICAgJy0tLSdcclxuICAgICAgICBdO1xyXG4gICAgICAgIGxpbmVzID0gbGluZXMuY29uY2F0KG1ldGEubWFwKHBhcmFtID0+IHtcclxuICAgICAgICAgICAgY29uc3QgZGVzYyA9IHBhcmFtLmNvbW1lbnRcclxuICAgICAgICAgICAgICAgID8gYCAtICR7cGFyYW0uY29tbWVudC50ZXh0fWBcclxuICAgICAgICAgICAgICAgIDogJyc7XHJcbiAgICAgICAgICAgIHJldHVybiBgLSAqKiR7cGFyYW0ubmFtZX0qKjogJHt0aGlzLnR5cGUocGFyYW0udHlwZSl9YCArIGRlc2M7XHJcbiAgICAgICAgfSkpO1xyXG4gICAgICAgIHJldHVybiBsaW5lcztcclxuICAgIH1cclxuXHJcbiAgICBhcmdzKG1ldGEpIHtcclxuICAgICAgICAgaWYgKCFtZXRhIHx8IG1ldGEubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIHJldHVybiAnJztcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG1ldGFcclxuICAgICAgICAgICAgLm1hcChhcmcgPT4gYCR7YXJnLm5hbWV9OiAke3RoaXMudHlwZShhcmcudHlwZSwgZmFsc2UpfWApXHJcbiAgICAgICAgICAgIC5qb2luKCcsICcpO1xyXG4gICAgfSAgICBcclxuXHJcbiAgICBpbnRlcmZhY2UobWV0YSkge1xyXG4gICAgICAgIGxldCBsaW5lcyA9IFtdO1xyXG4gICAgICAgIGlmIChtZXRhLmlkKSB7XHJcbiAgICAgICAgICAgIGxpbmVzLnB1c2goYDxhIG5hbWU9XCJpZC0ke21ldGEuaWR9XCI+PC9hPmApO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsaW5lcy5wdXNoKFxyXG4gICAgICAgICAgICBgSW50ZXJmYWNlIFske21ldGEubmFtZX1dYCxcclxuICAgICAgICAgICAgJz09PScsXHJcbiAgICAgICAgICAgICcnXHJcbiAgICAgICAgKTtcclxuICAgICAgICBpZiAobWV0YS5zaWduYXR1cmVzKSB7XHJcbiAgICAgICAgICAgIGxpbmVzLnB1c2goXHJcbiAgICAgICAgICAgICAgICAnU2lnbmF0dXJlJyxcclxuICAgICAgICAgICAgICAgICctLS0nLFxyXG4gICAgICAgICAgICAgICAgLi4udGhpcy5nZXRTaWduYXR1cmVDb2RlKG1ldGEuc2lnbmF0dXJlc1swXSlcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9ICAgICAgXHJcbiAgICAgICAgaWYgKG1ldGEuY2hpbGRyZW4gJiYgbWV0YS5jaGlsZHJlbi5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHByb3BzID0gbWV0YS5jaGlsZHJlbi5maWx0ZXIocHJvcCA9PiBwcm9wLmtpbmQgPSB0eXBlcy5Qcm9wZXJ0eSk7XHJcbiAgICAgICAgICAgIGxpbmVzLnB1c2goXHJcbiAgICAgICAgICAgICAgICAnUHJvcGV0aWVzOicsXHJcbiAgICAgICAgICAgICAgICAnLS0tJ1xyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICBsaW5lcyA9IGxpbmVzLmNvbmNhdChwcm9wcy5tYXAocHJvcCA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYC0gJHtwcm9wLm5hbWV9OiAke3RoaXMudHlwZShwcm9wLnR5cGUpfWBcclxuICAgICAgICAgICAgfSkpO1xyXG4gICAgICAgICAgICBsaW5lcy5wdXNoKCcnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGxpbmVzLmpvaW4oJ1xcbicpO1xyXG4gICAgfVxyXG5cclxuICAgIHJlZihyZWZEYXRhOiBSZWZSZWNvcmQsIHRleHQpIHtcclxuICAgICAgICBjb25zdCBwYXRoID0gdGhpcy5nZXRQYXRoKHJlZkRhdGEucGxhY2UpO1xyXG4gICAgICAgIGNvbnN0IGhhc2ggPSAnaWQtJyArIHJlZkRhdGEubWV0YS5pZDsgICAgICAgIFxyXG4gICAgICAgIGNvbnN0IHVybCA9IFt0aGlzLnVybEJhc2UsIHBhdGgsICcjJywgaGFzaF0uam9pbignJyk7XHJcbiAgICAgICAgcmV0dXJuIGBbJHt0ZXh0fV0oJHt1cmx9KWA7XHJcbiAgICB9XHJcblxyXG4gICAgdHlwZShtZXRhLCBhbGxvd0xpbmtzPXRydWUpIHtcclxuICAgICAgICBsZXQgcmVzID0gbWV0YS5uYW1lO1xyXG4gICAgICAgIGlmIChtZXRhLnR5cGVBcmd1bWVudHMgJiYgbWV0YS50eXBlQXJndW1lbnRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgLy8gdG9kbzogYWRkIHR5cGVBcmdzXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChhbGxvd0xpbmtzICYmIG1ldGEudHlwZSA9PT0gJ3JlZmVyZW5jZScgJiYgbWV0YS5pZCkge1xyXG4gICAgICAgICAgICBjb25zdCByZWYgPSB0aGlzLmxpbmtUYWJsZVttZXRhLmlkXTtcclxuICAgICAgICAgICAgcmVzID0gdGhpcy5yZWYocmVmLCByZXMpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzIHx8ICc8dW5zdXBwb3J0ZWQtdHlwZT4nO1xyXG4gICAgfVxyXG5cclxuICAgIHR5cGVQYXJhbShtZXRhKSB7XHJcbiAgICAgICAgaWYgKCFtZXRhIHx8IG1ldGEubGVuZ3RoID09PSAwKXtcclxuICAgICAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCB0eXBlTGlzdCA9IG1ldGEubWFwKG0gPT4gbS5uYW1lKS5qb2luKCcsICcpO1xyXG4gICAgICAgIHJldHVybiBgXFxcXDwke3R5cGVMaXN0fVxcXFw+YDtcclxuICAgIH1cclxuXHJcbiAgICBhbnkobWV0YSkge1xyXG4gICAgICAgIHN3aXRjaCAobWV0YS5raW5kKSB7XHJcbiAgICAgICAgICAgIGNhc2UgdHlwZXMuRnVuY3Rpb246XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zaWduYXR1cmUobWV0YS5zaWduYXR1cmVzWzBdKTtcclxuICAgICAgICAgICAgY2FzZSB0eXBlcy5JbnRlcmZhY2U6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbnRlcmZhY2UobWV0YSk7ICAgICAgICBcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2VuRG9jcyhtZXRhKTogRG9jRW50aXR5W10ge1xyXG4gICAgICAgIG1ldGEuY2hpbGRyZW4uZm9yRWFjaChtb2R1bGUgPT4ge1xyXG4gICAgICAgICAgICBtb2R1bGUuY2hpbGRyZW5cclxuICAgICAgICAgICAgICAgIC5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChpdGVtLmlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubGlua1RhYmxlW2l0ZW0uaWRdID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWV0YTogaXRlbSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBsYWNlOiBtb2R1bGUub3JpZ2luYWxOYW1lXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICB9KTtcclxuICAgICAgICByZXR1cm4gbWV0YS5jaGlsZHJlbi5tYXAobW9kdWxlID0+ICh7XHJcbiAgICAgICAgICAgIHBhdGg6IHRoaXMuZ2V0UGF0aChtb2R1bGUub3JpZ2luYWxOYW1lKSxcclxuICAgICAgICAgICAgY29udGVudDogbW9kdWxlLmNoaWxkcmVuXHJcbiAgICAgICAgICAgICAgICAubWFwKGl0ZW0gPT4gdGhpcy5hbnkoaXRlbSkpXHJcbiAgICAgICAgICAgICAgICAuam9pbignXFxuXFxuJylcclxuICAgICAgICB9KSk7XHJcbiAgICB9XHJcbn1cclxuIl19