"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const types = {
    Function: 64,
    Interface: 256,
    Property: 1024
};
class DocGenerator {
    constructor(cfg) {
        this.cwd = cfg.cwd;
        this.urlBase = cfg.urlBase;
        this.linkTable = {};
    }
    getPath(absPath) {
        return path.relative(this.cwd, absPath)
            .replace(/\\/g, '/')
            .replace(/\.[^\.]*$/, '.md');
    }
    getSignatureCode(meta) {
        if (!meta) {
            return [];
        }
        const resultType = this.type(meta.type, false);
        return [
            '```typescript',
            `(${this.args(meta.parameters)}) => ${resultType}`,
            '```'
        ];
    }
    signature(meta) {
        const name = meta.name;
        const typeArgs = this.typeParam(meta.typeParameter);
        let lines = [
            `Function [${name + typeArgs}]`,
            '===',
            '',
            'Signature',
            '---'
        ];
        lines = lines.concat(this.getSignatureCode(meta));
        lines.push('');
        if (meta.comment) {
            lines = lines.concat([
                'Description',
                '---',
                meta.comment.shortText,
                ''
            ]);
        }
        lines = lines.concat(this.params(meta.parameters));
        return lines.join('\n');
    }
    params(meta) {
        if (!meta || meta.length === 0) {
            return [];
        }
        let lines = [
            'Parameters',
            '---'
        ];
        lines = lines.concat(meta.map(param => {
            const desc = param.comment
                ? ` - ${param.comment.text}`
                : '';
            return `- **${param.name}**: ${this.type(param.type)}` + desc;
        }));
        return lines;
    }
    args(meta) {
        if (!meta || meta.length === 0) {
            return '';
        }
        return meta
            .map(arg => `${arg.name}: ${this.type(arg.type, false)}`)
            .join(', ');
    }
    interface(meta) {
        let lines = [];
        if (meta.id) {
            lines.push(`<a name="id-${meta.id}"></a>`);
        }
        lines.push(`Interface [${meta.name}]`, '===', '');
        if (meta.children && meta.children.length > 0) {
            const props = meta.children.filter(prop => prop.kind = types.Property);
            lines.push('Propeties:', '---');
            lines = lines.concat(props.map(prop => {
                return `- ${prop.name}: ${this.type(prop.type)}`;
            }));
            lines.push('');
        }
        return lines.join('\n');
    }
    ref(refData, text) {
        const path = this.getPath(refData.place);
        const hash = 'id-' + refData.meta.id;
        const url = [this.urlBase, path, '#', hash].join('');
        return `[${text}](${url})`;
    }
    type(meta, allowLinks = true) {
        let res = meta.name;
        if (res.typeArguments && res.typeArguments.length > 0) {
        }
        if (allowLinks && meta.type === 'reference' && meta.id) {
            const ref = this.linkTable[meta.id];
            res = this.ref(ref, res);
        }
        return res;
    }
    typeParam(meta) {
        if (!meta || meta.length === 0) {
            return '';
        }
        const typeList = meta.map(m => m.name).join(', ');
        return `\\<${typeList}\\>`;
    }
    any(meta) {
        switch (meta.kind) {
            case types.Function:
                return this.signature(meta.signatures[0]);
            case types.Interface:
                return this.interface(meta);
        }
    }
    genDocs(meta) {
        meta.children.forEach(module => {
            module.children
                .forEach(item => {
                if (item.id) {
                    this.linkTable[item.id] = {
                        meta: item,
                        place: module.originalName
                    };
                }
            });
        });
        return meta.children.map(module => ({
            path: this.getPath(module.originalName),
            content: module.children
                .map(item => this.any(item))
                .join('\n\n')
        }));
    }
}
exports.DocGenerator = DocGenerator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHlwZWRvYy1tZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy90eXBlZG9jLW1kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNkJBQTZCO0FBRTdCLE1BQU0sS0FBSyxHQUFHO0lBQ1YsUUFBUSxFQUFFLEVBQUU7SUFDWixTQUFTLEVBQUUsR0FBRztJQUNkLFFBQVEsRUFBRSxJQUFJO0NBQ2pCLENBQUE7QUFpQkQ7SUFLSSxZQUFhLEdBQWM7UUFDdkIsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDO1FBQ25CLElBQUksQ0FBQyxPQUFPLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQztRQUMzQixJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztJQUN4QixDQUFDO0lBRUQsT0FBTyxDQUFDLE9BQWU7UUFDbkIsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUM7YUFDbEMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUM7YUFDbkIsT0FBTyxDQUFDLFdBQVcsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNyQyxDQUFDO0lBRUQsZ0JBQWdCLENBQUMsSUFBSTtRQUNqQixFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDUixNQUFNLENBQUMsRUFBRSxDQUFDO1FBQ2QsQ0FBQztRQUNELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztRQUMvQyxNQUFNLENBQUM7WUFDSCxlQUFlO1lBQ2YsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxVQUFVLEVBQUU7WUFDbEQsS0FBSztTQUNSLENBQUE7SUFDTCxDQUFDO0lBRUQsU0FBUyxDQUFDLElBQUk7UUFDVixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMs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LFFBQVE7aUJBQ1YsT0FBTyxDQUFDLElBQUk7Z0JBQ1QsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7b0JBQ1YsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEdBQUc7d0JBQ3RCLElBQUksRUFBRSxJQUFJO3dCQUNWLEtBQUssRUFBRSxNQUFNLENBQUMsWUFBWTtxQkFDN0IsQ0FBQztnQkFDTixDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUE7UUFDVixDQUFDLENBQUMsQ0FBQztRQUNILE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLElBQUksQ0FBQztZQUNoQyxJQUFJLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDO1lBQ3ZDLE9BQU8sRUFBRSxNQUFNLENBQUMsUUFBUTtpQkFDbkIsR0FBRyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO2lCQUMzQixJQUFJLENBQUMsTUFBTSxDQUFDO1NBQ3BCLENBQUMsQ0FBQyxDQUFDO0lBQ1IsQ0FBQztDQUNKO0FBOUpELG9DQThKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XHJcblxyXG5jb25zdCB0eXBlcyA9IHtcclxuICAgIEZ1bmN0aW9uOiA2NCxcclxuICAgIEludGVyZmFjZTogMjU2LFxyXG4gICAgUHJvcGVydHk6IDEwMjRcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBSZWZSZWNvcmQge1xyXG4gICAgbWV0YTogYW55O1xyXG4gICAgcGxhY2U6IHN0cmluZztcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBEb2NHZW5DZmcge1xyXG4gICAgY3dkOiBzdHJpbmc7XHJcbiAgICB1cmxCYXNlOiBzdHJpbmc7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRG9jRW50aXR5IHtcclxuICAgIGNvbnRlbnQ6IHN0cmluZztcclxuICAgIHBhdGg6IHN0cmluZztcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIERvY0dlbmVyYXRvciB7XHJcbiAgICBsaW5rVGFibGU6IHtba2V5OiBzdHJpbmddOiBSZWZSZWNvcmR9O1xyXG4gICAgY3dkOiBzdHJpbmc7XHJcbiAgICB1cmxCYXNlOiBzdHJpbmc7XHJcblxyXG4gICAgY29uc3RydWN0b3IgKGNmZzogRG9jR2VuQ2ZnKSB7XHJcbiAgICAgICAgdGhpcy5jd2QgPSBjZmcuY3dkO1xyXG4gICAgICAgIHRoaXMudXJsQmFzZSA9IGNmZy51cmxCYXNlO1xyXG4gICAgICAgIHRoaXMubGlua1RhYmxlID0ge307XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0UGF0aChhYnNQYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgICAgIHJldHVybiBwYXRoLnJlbGF0aXZlKHRoaXMuY3dkLCBhYnNQYXRoKVxyXG4gICAgICAgICAgICAucmVwbGFjZSgvXFxcXC9nLCAnLycpXHJcbiAgICAgICAgICAgIC5yZXBsYWNlKC9cXC5bXlxcLl0qJC8sICcubWQnKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRTaWduYXR1cmVDb2RlKG1ldGEpIHtcclxuICAgICAgICBpZiAoIW1ldGEpIHtcclxuICAgICAgICAgICAgcmV0dXJuIFtdO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCByZXN1bHRUeXBlID0gdGhpcy50eXBlKG1ldGEudHlwZSwgZmFsc2UpO1xyXG4gICAgICAgIHJldHVybiBbICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICdgYGB0eXBlc2NyaXB0JyxcclxuICAgICAgICAgICAgYCgke3RoaXMuYXJncyhtZXRhLnBhcmFtZXRlcnMpfSkgPT4gJHtyZXN1bHRUeXBlfWAsXHJcbiAgICAgICAgICAgICdgYGAnICAgICAgIFxyXG4gICAgICAgIF1cclxuICAgIH1cclxuXHJcbiAgICBzaWduYXR1cmUobWV0YSkge1xyXG4gICAgICAgIGNvbnN0IG5hbWUgPSBtZXRhLm5hbWU7XHJcbiAgICAgICAgY29uc3QgdHlwZUFyZ3MgPSB0aGlzLnR5cGVQYXJhbShtZXRhLnR5cGVQYXJhbWV0ZXIpO1xyXG4gICAgICAgIGxldCBsaW5lcyA9IFtcclxuICAgICAgICAgICAgYEZ1bmN0aW9uIFske25hbWUgKyB0eXBlQXJnc31dYCxcclxuICAgICAgICAgICAgJz09PScsXHJcbiAgICAgICAgICAgICcnLFxyXG4gICAgICAgICAgICAnU2lnbmF0dXJlJyxcclxuICAgICAgICAgICAgJy0tLSdcclxuICAgICAgICBdOyAgICBcclxuICAgICAgICBsaW5lcyA9IGxpbmVzLmNvbmNhdCh0aGlzLmdldFNpZ25hdHVyZUNvZGUobWV0YSkpO1xyXG4gICAgICAgIGxpbmVzLnB1c2goJycpO1xyXG4gICAgICAgIGlmIChtZXRhLmNvbW1lbnQpIHtcclxuICAgICAgICAgICAgbGluZXMgPSBsaW5lcy5jb25jYXQoW1xyXG4gICAgICAgICAgICAgICAgJ0Rlc2NyaXB0aW9uJyxcclxuICAgICAgICAgICAgICAgICctLS0nLFxyXG4gICAgICAgICAgICAgICAgbWV0YS5jb21tZW50LnNob3J0VGV4dCxcclxuICAgICAgICAgICAgICAgICcnICAgICBcclxuICAgICAgICAgICAgXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxpbmVzID0gbGluZXMuY29uY2F0KHRoaXMucGFyYW1zKG1ldGEucGFyYW1ldGVycykpO1xyXG4gICAgICAgIHJldHVybiBsaW5lcy5qb2luKCdcXG4nKTtcclxuICAgIH1cclxuXHJcbiAgICBwYXJhbXMobWV0YSkge1xyXG4gICAgICAgIGlmICghbWV0YSB8fCBtZXRhLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICByZXR1cm4gW107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCBsaW5lcyA9IFtcclxuICAgICAgICAgICAgJ1BhcmFtZXRlcnMnLFxyXG4gICAgICAgICAgICAnLS0tJ1xyXG4gICAgICAgIF07XHJcbiAgICAgICAgbGluZXMgPSBsaW5lcy5jb25jYXQobWV0YS5tYXAocGFyYW0gPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBkZXNjID0gcGFyYW0uY29tbWVudFxyXG4gICAgICAgICAgICAgICAgPyBgIC0gJHtwYXJhbS5jb21tZW50LnRleHR9YFxyXG4gICAgICAgICAgICAgICAgOiAnJztcclxuICAgICAgICAgICAgcmV0dXJuIGAtICoqJHtwYXJhbS5uYW1lfSoqOiAke3RoaXMudHlwZShwYXJhbS50eXBlKX1gICsgZGVzYztcclxuICAgICAgICB9KSk7XHJcbiAgICAgICAgcmV0dXJuIGxpbmVzO1xyXG4gICAgfVxyXG5cclxuICAgIGFyZ3MobWV0YSkge1xyXG4gICAgICAgICBpZiAoIW1ldGEgfHwgbWV0YS5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuICcnO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbWV0YVxyXG4gICAgICAgICAgICAubWFwKGFyZyA9PiBgJHthcmcubmFtZX06ICR7dGhpcy50eXBlKGFyZy50eXBlLCBmYWxzZSl9YClcclxuICAgICAgICAgICAgLmpvaW4oJywgJyk7XHJcbiAgICB9ICAgIFxyXG5cclxuICAgIGludGVyZmFjZShtZXRhKSB7XHJcbiAgICAgICAgbGV0IGxpbmVzID0gW107XHJcbiAgICAgICAgaWYgKG1ldGEuaWQpIHtcclxuICAgICAgICAgICAgbGluZXMucHVzaChgPGEgbmFtZT1cImlkLSR7bWV0YS5pZH1cIj48L2E+YCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxpbmVzLnB1c2goXHJcbiAgICAgICAgICAgIGBJbnRlcmZhY2UgWyR7bWV0YS5uYW1lfV1gLFxyXG4gICAgICAgICAgICAnPT09JyxcclxuICAgICAgICAgICAgJydcclxuICAgICAgICApO1xyXG4gICAgICAgIGlmIChtZXRhLmNoaWxkcmVuICYmIG1ldGEuY2hpbGRyZW4ubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICBjb25zdCBwcm9wcyA9IG1ldGEuY2hpbGRyZW4uZmlsdGVyKHByb3AgPT4gcHJvcC5raW5kID0gdHlwZXMuUHJvcGVydHkpO1xyXG4gICAgICAgICAgICBsaW5lcy5wdXNoKFxyXG4gICAgICAgICAgICAgICAgJ1Byb3BldGllczonLFxyXG4gICAgICAgICAgICAgICAgJy0tLSdcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgbGluZXMgPSBsaW5lcy5jb25jYXQocHJvcHMubWFwKHByb3AgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGAtICR7cHJvcC5uYW1lfTogJHt0aGlzLnR5cGUocHJvcC50eXBlKX1gXHJcbiAgICAgICAgICAgIH0pKTtcclxuICAgICAgICAgICAgbGluZXMucHVzaCgnJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBsaW5lcy5qb2luKCdcXG4nKTtcclxuICAgIH1cclxuXHJcbiAgICByZWYocmVmRGF0YTogUmVmUmVjb3JkLCB0ZXh0KSB7XHJcbiAgICAgICAgY29uc3QgcGF0aCA9IHRoaXMuZ2V0UGF0aChyZWZEYXRhLnBsYWNlKTtcclxuICAgICAgICBjb25zdCBoYXNoID0gJ2lkLScgKyByZWZEYXRhLm1ldGEuaWQ7ICAgICAgICBcclxuICAgICAgICBjb25zdCB1cmwgPSBbdGhpcy51cmxCYXNlLCBwYXRoLCAnIycsIGhhc2hdLmpvaW4oJycpO1xyXG4gICAgICAgIHJldHVybiBgWyR7dGV4dH1dKCR7dXJsfSlgO1xyXG4gICAgfVxyXG5cclxuICAgIHR5cGUobWV0YSwgYWxsb3dMaW5rcz10cnVlKSB7XHJcbiAgICAgICAgbGV0IHJlcyA9IG1ldGEubmFtZTtcclxuICAgICAgICBpZiAocmVzLnR5cGVBcmd1bWVudHMgJiYgcmVzLnR5cGVBcmd1bWVudHMubGVuZ3RoID4gMCkge1xyXG5cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGFsbG93TGlua3MgJiYgbWV0YS50eXBlID09PSAncmVmZXJlbmNlJyAmJiBtZXRhLmlkKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlZiA9IHRoaXMubGlua1RhYmxlW21ldGEuaWRdO1xyXG4gICAgICAgICAgICByZXMgPSB0aGlzLnJlZihyZWYsIHJlcyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiByZXM7XHJcbiAgICB9XHJcblxyXG4gICAgdHlwZVBhcmFtKG1ldGEpIHtcclxuICAgICAgICBpZiAoIW1ldGEgfHwgbWV0YS5sZW5ndGggPT09IDApe1xyXG4gICAgICAgICAgICByZXR1cm4gJyc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHR5cGVMaXN0ID0gbWV0YS5tYXAobSA9PiBtLm5hbWUpLmpvaW4oJywgJyk7XHJcbiAgICAgICAgcmV0dXJuIGBcXFxcPCR7dHlwZUxpc3R9XFxcXD5gO1xyXG4gICAgfVxyXG5cclxuICAgIGFueShtZXRhKSB7XHJcbiAgICAgICAgc3dpdGNoIChtZXRhLmtpbmQpIHtcclxuICAgICAgICAgICAgY2FzZSB0eXBlcy5GdW5jdGlvbjpcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLnNpZ25hdHVyZShtZXRhLnNpZ25hdHVyZXNbMF0pO1xyXG4gICAgICAgICAgICBjYXNlIHR5cGVzLkludGVyZmFjZTpcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmludGVyZmFjZShtZXRhKTsgICAgICAgIFxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnZW5Eb2NzKG1ldGEpOiBEb2NFbnRpdHlbXSB7XHJcbiAgICAgICAgbWV0YS5jaGlsZHJlbi5mb3JFYWNoKG1vZHVsZSA9PiB7XHJcbiAgICAgICAgICAgIG1vZHVsZS5jaGlsZHJlblxyXG4gICAgICAgICAgICAgICAgLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW0uaWQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5saW5rVGFibGVbaXRlbS5pZF0gPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRhOiBpdGVtLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcGxhY2U6IG1vZHVsZS5vcmlnaW5hbE5hbWVcclxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHJldHVybiBtZXRhLmNoaWxkcmVuLm1hcChtb2R1bGUgPT4gKHtcclxuICAgICAgICAgICAgcGF0aDogdGhpcy5nZXRQYXRoKG1vZHVsZS5vcmlnaW5hbE5hbWUpLFxyXG4gICAgICAgICAgICBjb250ZW50OiBtb2R1bGUuY2hpbGRyZW5cclxuICAgICAgICAgICAgICAgIC5tYXAoaXRlbSA9PiB0aGlzLmFueShpdGVtKSlcclxuICAgICAgICAgICAgICAgIC5qb2luKCdcXG5cXG4nKVxyXG4gICAgICAgIH0pKTtcclxuICAgIH1cclxufVxyXG4iXX0=